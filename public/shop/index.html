<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Fish & Chill Shop</title>

    <!-- FONT -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@600;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --ink: #e9f4f4;
            --muted: #6d7a7a;
            --button: #2a86c7;
            --button-hover: #2476ad;
        }

        * {
            box-sizing: border-box;
            user-select: none;
        }

        /* FONDO SUBMARINO */
        body {
            margin: 0;
            font-family: "Nunito", sans-serif;
            background:
                    radial-gradient(1200px 800px at 20% -10%, rgba(5, 25, 50, 0.6), transparent 70%),
                    radial-gradient(1200px 800px at 120% 0%, rgba(10, 40, 70, 0.6), transparent 70%),
                    #0b2239;
            color: var(--ink);
            overflow-x: hidden;
        }

        /* CAPA DE ANIMACI√ìN DETR√ÅS */
        .bg-anim {
            position: fixed;
            inset: 0;
            overflow: hidden;
            pointer-events: none;
            z-index: -1;
        }

        /* BURBUJAS */
        .bubbles span {
            position: absolute;
            bottom: -80px;
            display: block;
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.6);
            box-shadow: 0 0 8px rgba(255,255,255,0.9);
            animation: rise 12s linear infinite;
        }

        /* 18 burbujas */
        .bubbles span:nth-child(1)  { left: 5%;  width: 12px; height: 12px; animation-duration: 11s; }
        .bubbles span:nth-child(2)  { left: 15%; width: 18px; height: 18px; animation-duration: 14s; }
        .bubbles span:nth-child(3)  { left: 22%; width: 10px; height: 10px; animation-duration: 10s; }
        .bubbles span:nth-child(4)  { left: 30%; width: 8px;  height: 8px;  animation-duration: 9s; }
        .bubbles span:nth-child(5)  { left: 38%; width: 16px; height: 16px; animation-duration: 13s; }
        .bubbles span:nth-child(6)  { left: 45%; width: 14px; height: 14px; animation-duration: 12s; }
        .bubbles span:nth-child(7)  { left: 50%; width: 7px;  height: 7px;  animation-duration: 9s; }
        .bubbles span:nth-child(8)  { left: 58%; width: 20px; height: 20px; animation-duration: 16s; }
        .bubbles span:nth-child(9)  { left: 63%; width: 9px;  height: 9px; animation-duration: 11s; }
        .bubbles span:nth-child(10) { left: 70%; width: 13px; height: 13px; animation-duration: 10s; }
        .bubbles span:nth-child(11) { left: 75%; width: 17px; height: 17px; animation-duration: 14s; }
        .bubbles span:nth-child(12) { left: 80%; width: 11px; height: 11px; animation-duration: 12s; }
        .bubbles span:nth-child(13) { left: 85%; width: 15px; height: 15px; animation-duration: 15s; }
        .bubbles span:nth-child(14) { left: 88%; width: 7px;  height: 7px;  animation-duration: 9s; }
        .bubbles span:nth-child(15) { left: 92%; width: 18px; height: 18px; animation-duration: 16s; }
        .bubbles span:nth-child(16) { left: 96%; width: 10px; height: 10px; animation-duration: 8s; }
        .bubbles span:nth-child(17) { left: 50%; width: 22px; height: 22px; animation-duration: 18s; }
        .bubbles span:nth-child(18) { left: 32%; width: 6px;  height: 6px; animation-duration: 7s; }

        @keyframes rise {
            0% { transform: translateY(0) scale(.9); opacity: 0; }
            10%,80% { opacity: 1; }
            100% { transform: translateY(-120vh) scale(1.2); opacity: 0; }
        }

        /* PECES */
        .fishes .fish {
            position: absolute;
            width: 60px;
            height: 28px;
            border-radius: 999px;
            box-shadow: 0 0 8px rgba(0,0,0,0.25);
            animation-timing-function: linear;
            animation-iteration-count: infinite;
        }

        .fish::before {
            content: "";
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 18px;
            height: 20px;
            border-radius: 4px;
            left: var(--tail-x);
            background: var(--tail-color);
        }

        .fish::after {
            content: "";
            position: absolute;
            top: 9px;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: white;
            box-shadow: 2px 0 0 #000 inset;
            left: var(--eye-x);
        }

        @keyframes swim-right {
            0%   { transform: translateX(-120px); }
            100% { transform: translateX(110vw); }
        }

        @keyframes swim-left {
            0%   { transform: translateX(110vw); }
            100% { transform: translateX(-120px); }
        }

        /* HEADER */
        header {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(6px);
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 10;
            color: white;
        }

        h1 {
            margin: 0;
            font-size: 24px;
            text-shadow: 0 2px 4px rgba(0,0,0,.4);
        }

        #user-info {
            background: rgba(255,255,255,0.4);
            padding: 6px 12px;
            border-radius: 12px;
            font-weight: 700;
        }

        main {
            max-width: 900px;
            margin: 20px auto;
            padding: 0 20px;
        }

        /* CONTENEDOR DE CA√ëAS EN GRID */
        #rods {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 18px;
        }

        /* TARJETAS DE CA√ëAS */
        .rod {
            display: flex;
            gap: 18px;
            background: rgba(255,255,255,0.92);
            border-radius: 16px;
            padding: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,.2);
            position: relative;
        }
        .rod:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 28px rgba(0,0,0,.3);
        }

        .rod img {
            width: 80px;
            height: 80px;
            border-radius: 12px;
            object-fit: cover;
        }

        .rod-info header {
            font-size: 18px;
            font-weight: 800;
            color: var(--button);
        }

        .stats {
            font-size: 14px;
            color: var(--muted);
        }

        .price {
            font-weight: 800;
            margin-top: 8px;
            color: var(--button);
        }

        /* BOT√ìN */
        button.buy {
            margin-top: 10px;
            padding: 10px 16px;
            background: var(--button);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 800;
            cursor: pointer;
            transition: .15s;
        }
        button.buy:hover {
            background: var(--button-hover);
            transform: scale(1.03);
        }

        /* MENSAJE FLOTANTE */
        .float-msg {
            position: absolute;
            left: 50%;
            top: -5px;
            transform: translateX(-50%);
            padding: 10px 16px;
            border-radius: 10px;
            font-weight: 800;
            background: rgba(255,255,255,0.95);
            animation: floatUp 1.2s ease forwards;
            pointer-events: none;
            box-shadow: 0 4px 20px rgba(0,0,0,0.25);
            z-index: 20;
        }

        .float-success {
            color: #2a9d6f;
            border: 2px solid rgba(42,157,111,0.4);
        }

        .float-error {
            color: #c44747;
            border: 2px solid rgba(200,70,70,0.4);
        }

        @keyframes floatUp {
            0%   { opacity: 0; transform: translate(-50%, 10px) scale(0.9); }
            10%  { opacity: 1; }
            85%  { opacity: 1; transform: translate(-50%, -20px) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -40px); }
        }

    </style>
</head>

<body>

<!-- FISHES AND BUBBLES -->
<div class="bg-anim">
    <div class="bubbles">
        <span></span><span></span><span></span><span></span><span></span><span></span>
        <span></span><span></span><span></span><span></span><span></span><span></span>
        <span></span><span></span><span></span><span></span><span></span><span></span>
    </div>

    <div class="fishes">
        <div class="fish f1"></div>
        <div class="fish f2"></div>
        <div class="fish f3"></div>
        <div class="fish f4"></div>
        <div class="fish f5"></div>
        <div class="fish f6"></div>
    </div>
</div>

<header>
    <h1>üé£ Fishing Rod Shop</h1>
    <p id="user-info">Loading...</p>
</header>

<main>
    <div id="rods"></div>
</main>

<script>
    /* ===================================== */
    /* FISHES WITH ORIENTATION              */
    /* ===================================== */

    function randomColor() {
        const colors = [
            ["#ff6b6b", "#ffb347"],
            ["#6b8cff", "#4661ff"],
            ["#6bff95", "#20c659"],
            ["#ff6bf3", "#d446ff"],
            ["#ffd36b", "#ffb200"],
            ["#6bfff1", "#2ed8cc"],
        ];
        return colors[Math.floor(Math.random() * colors.length)];
    }

    function randomFishBehavior(fish, index) {
        const top = 10 + index * 13 + Math.random() * 10;
        fish.style.top = top + "%";

        const duration = 18 + Math.random() * 10;
        fish.style.animationDuration = duration + "s";

        const goLeft = Math.random() < 0.5;

        if (goLeft) {
            fish.style.animationName = "swim-left";
            fish.style.setProperty("--tail-x", "calc(100% - 4px)");
            fish.style.setProperty("--eye-x", "8px");
        } else {
            fish.style.animationName = "swim-right";
            fish.style.setProperty("--tail-x", "-18px");
            fish.style.setProperty("--eye-x", "calc(100% - 16px)");
        }

        const [c1, c2] = randomColor();
        fish.style.background = `linear-gradient(90deg, ${c1}, ${c2})`;
        fish.style.setProperty("--tail-color", c1);
    }

    document.addEventListener("DOMContentLoaded", () => {
        document.querySelectorAll(".fish").forEach((fish, i) => {
            randomFishBehavior(fish, i);
        });
    });


    /* ===================================== */
    /*  SHOP LOGIC                          */
    /* ===================================== */

    (function () {
        const info = document.getElementById('user-info');
        const rodsContainer = document.getElementById('rods');
        const token = localStorage.getItem('authToken');

        async function init() {
            await loadMe();
            await initShop();
        }

        if (!token) {
            info.textContent = 'No session ‚Äî Redirecting...';
            setTimeout(() => window.location.href = '../index.html', 1200);
        } else {
            init();
        }

        async function loadMe() {
            const res = await fetch('/api/me', {
                headers: { 'Authorization': token }
            });

            if (!res.ok) return;

            const user = await res.json();
            const name = user.username;
            const coins = user.coins;

            info.textContent = `${name} | üí∞ ${coins} coins`;
        }

        async function initShop() {

            await loadRods();
        }

        async function loadRods() {
            const res = await fetch('/api/catalog/fishing_rods', {
                headers: { 'Authorization': token }
            });

            if (!res.ok) return;

            const rods = await res.json();
            renderRods(rods);
        }

        function renderRods(rods) {
            rodsContainer.innerHTML = '';
            rods.forEach(rod => {
                const el = document.createElement('div');
                el.className = 'rod';

                // üëá Here we use directly the link that comes from the backend
                const imgSrc = rod.url ; //"/img/fishing_rods/fishing_rod_name.png";

                el.innerHTML = `
              <img src="${imgSrc}" alt="${rod.name}">
              <div class="rod-info">
                <header>${rod.name}</header>
                <div class="stats">
                  Speed: ${rod.speed} | Power: ${rod.power} | Rarity: ${rod.rarity}<br>
                  Durability: ${rod.durability}
                </div>
                <div class="price">üí∞ ${rod.price} coins</div>
                <button class="buy">Buy</button>
              </div>
            `;

                el.querySelector('.buy').addEventListener('click', () =>
                    buyFishingRod(rod.id, rod.name, rod.price, el)
                );

                rodsContainer.appendChild(el);
            });
        }

        /* FLOATING MESSAGE */
        function showFloatMsg(parentEl, text, ok = true) {
            parentEl.style.position = "relative";

            const msg = document.createElement("div");
            msg.className = "float-msg " + (ok ? "float-success" : "float-error");
            msg.textContent = text;

            parentEl.appendChild(msg);
            setTimeout(() => msg.remove(), 1300);
        }

        async function buyFishingRod(id, name, price, parentEl) {
            const res = await fetch(`/api/shop/fishing_rods/${encodeURIComponent(name)}/buy`, {
                method: 'POST',
                headers: { 'Authorization': token }
            });

            if (!res.ok) {
                const text = await res.text();
                showFloatMsg(parentEl, "‚ùå " + text, false);
                return;
            }

            showFloatMsg(parentEl, `‚úÖ You bought ${name} for ${price} coins!`, true);
            await loadMe();
        }

    })();
</script>

</body>
</html>